<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Simulador de Mus - Testing Backend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 80vh;
        }

        .left-panel {
            padding: 24px;
            border-right: 1px solid #e1e8ed;
        }

        .right-panel {
            padding: 24px;
            background: #fafbfc;
        }

        .section {
            margin-bottom: 32px;
        }

        .section h3 {
            color: #1a202c;
            margin-bottom: 16px;
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3182ce;
            color: white;
        }

        .btn-primary:hover {
            background: #2c5aa0;
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-success:hover {
            background: #2f855a;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-warning {
            background: #d69e2e;
            color: white;
        }

        .btn-warning:hover {
            background: #b7791f;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Game State */
        .game-state {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 1.4em;
            font-weight: 600;
        }

        .scores {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 16px;
        }

        .score {
            text-align: center;
            padding: 12px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            min-width: 80px;
        }

        /* Players */
        .players-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .player-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            background: white;
            transition: all 0.2s ease;
        }

        .player-card.active {
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .player-card.team-0 {
            border-left: 4px solid #e53e3e;
        }

        .player-card.team-1 {
            border-left: 4px solid #38a169;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .player-name {
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-connected {
            background: #38a169;
        }

        .status-disconnected {
            background: #e53e3e;
        }

        .team-badge {
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .team-0 .team-badge {
            background: #fed7d7;
            color: #c53030;
        }

        .team-1 .team-badge {
            background: #c6f6d5;
            color: #2f855a;
        }

        /* Cards */
        .hand {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px;
            min-width: 60px;
            height: 80px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card:hover {
            border-color: #3182ce;
            transform: translateY(-2px);
        }

        .card.selected {
            background: #3182ce;
            color: white;
            border-color: #2c5aa0;
        }

        .card-value {
            font-size: 1.1em;
            font-weight: 600;
        }

        .card-suit {
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Mus suits - Spanish deck */
        .suit-oros {
            color: #d69e2e;
        }

        .suit-copas {
            color: #e53e3e;
        }

        .suit-espadas {
            color: #2d3748;
        }

        .suit-bastos {
            color: #38a169;
        }

        .actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .action-btn {
            padding: 6px 10px;
            font-size: 0.8em;
            border-radius: 4px;
        }

        /* Controls */
        .control-group {
            margin-bottom: 16px;
        }

        .control-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2d3748;
            font-size: 0.9em;
        }

        .control-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.2s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Log */
        .log-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            height: 100%;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.85em;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
        }

        .log-info { color: #63b3ed; }
        .log-success { color: #68d391; }
        .log-error { color: #fc8181; }
        .log-warning { color: #f6e05e; }

        .log-controls {
            margin-top: 12px;
        }

        /* Card Editor */
        .card-editor {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .card-editor h4 {
            margin-bottom: 12px;
            color: #2d3748;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-edit-item {
            text-align: center;
        }

        .card-edit-item label {
            display: block;
            margin-bottom: 4px;
            font-size: 0.8em;
            color: #4a5568;
        }

        .card-edit-select {
            width: 100%;
            padding: 6px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.8em;
        }

        /* Error Display */
        .error-display {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 0.9em;
        }

        .error-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .error-details {
            font-family: monospace;
            font-size: 0.8em;
            background: rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            white-space: pre-wrap;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .players-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Simulador de Mus</h1>
            <p>Herramienta de testing para el backend</p>
        </div>

        <div class="main-content">
            <!-- Panel Izquierdo: Juego -->
            <div class="left-panel">
                <!-- Controles principales -->
                <div class="section">
                    <h3>üéØ Controles</h3>
                    <div class="controls">
                        <button class="btn btn-success" onclick="createGame()">
                            üéÆ Crear Partida
                        </button>
                        <button class="btn btn-warning" onclick="simulateGame()" id="simulateBtn" disabled>
                            ü§ñ Simular
                        </button>
                        <button class="btn btn-primary" onclick="refreshGame()" id="refreshBtn" disabled>
                            üîÑ Actualizar
                        </button>
                        <button class="btn btn-danger" onclick="cleanup()">
                            üßπ Limpiar
                        </button>
                    </div>
                </div>

                <!-- Estado del juego -->
                <div class="section">
                    <div id="gameInfo" class="loading show">
                        <p>No hay partida activa.<br>Crea una partida para empezar.</p>
                    </div>
                </div>

                <!-- Jugadores -->
                <div class="section">
                    <h3>üë• Jugadores</h3>
                    <div id="playersContainer" class="loading show">
                        <p>Esperando partida...</p>
                    </div>
                </div>

                <!-- Controles de Estado -->
                <div class="section" id="stateControlsSection" style="display: none;">
                    <h3>‚öôÔ∏è Control de Estado</h3>
                    <div id="stateControls"></div>
                </div>

                <!-- Editor de Cartas -->
                <div class="section" id="cardEditorSection" style="display: none;">
                    <h3>üé¥ Editor de Cartas</h3>
                    <div id="cardEditor"></div>
                </div>
            </div>

            <!-- Panel Derecho: Log y Testing -->
            <div class="right-panel">
                <!-- Error Display -->
                <div id="errorDisplay" style="display: none;"></div>

                <!-- Log -->
                <div class="section">
                    <h3>üìù Log de Actividad</h3>
                    <div class="log-container">
                        <div id="log" class="log">
                            <div class="log-entry log-info">[${new Date().toLocaleTimeString()}] üöÄ Simulador iniciado</div>
                            <div class="log-entry log-info">[${new Date().toLocaleTimeString()}] üí° Crea una partida para empezar</div>
                        </div>
                    </div>
                    <div class="log-controls">
                        <div class="controls">
                            <button class="btn btn-warning" onclick="clearLog()">üóëÔ∏è Limpiar</button>
                            <button class="btn btn-primary" onclick="exportLog()">üì§ Exportar</button>
                            <button class="btn btn-primary" onclick="runBasicTests()">üß™ Tests</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentGameId = null;
        let currentGameState = null;
        let selectedCards = new Map();
        let selectedPlayer = null;
        let cardEditorData = {};

        const API_BASE = window.location.origin;

        // Logging
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log limpiado', 'info');
        }

        function exportLog() {
            const logEntries = document.querySelectorAll('.log-entry');
            const logText = Array.from(logEntries).map(entry => entry.textContent).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mus-simulator-log-${new Date().toISOString().slice(0,19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('üì§ Log exportado', 'success');
        }

        // Error handling
        function showError(title, message, details = null) {
            const errorDisplay = document.getElementById('errorDisplay');
            errorDisplay.style.display = 'block';
            errorDisplay.innerHTML = `
                <div class="error-display">
                    <div class="error-title">${title}</div>
                    <div>${message}</div>
                    ${details ? `<div class="error-details">${details}</div>` : ''}
                </div>
            `;
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                errorDisplay.style.display = 'none';
            }, 10000);
        }

        function hideError() {
            document.getElementById('errorDisplay').style.display = 'none';
        }

        // API calls with better error handling
        async function apiCall(endpoint, options = {}) {
            try {
                hideError();
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorDetails = {
                        status: response.status,
                        statusText: response.statusText,
                        endpoint: endpoint,
                        method: options.method || 'GET',
                        data: data
                    };
                    
                    showError(
                        `Error ${response.status}`,
                        data.error || `Error en ${endpoint}`,
                        JSON.stringify(errorDetails, null, 2)
                    );
                    
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showError(
                        'Error de Conexi√≥n',
                        'No se puede conectar con el servidor',
                        `Endpoint: ${endpoint}\nError: ${error.message}`
                    );
                }
                
                log(`‚ùå Error en ${endpoint}: ${error.message}`, 'error');
                throw error;
            }
        }

        // Game functions
        async function createGame() {
            try {
                log('üéÆ Creando nueva partida...', 'info');
                const result = await apiCall('/test/create-game', { method: 'POST' });
                
                currentGameId = result.gameId;
                log(`‚úÖ Partida creada: ${currentGameId}`, 'success');
                log(`üë• Jugadores: ${result.players.map(p => `${p.name} (Equipo ${p.team})`).join(', ')}`, 'info');
                
                document.getElementById('simulateBtn').disabled = false;
                document.getElementById('refreshBtn').disabled = false;
                document.getElementById('stateControlsSection').style.display = 'block';
                document.getElementById('cardEditorSection').style.display = 'block';
                
                await refreshGame();
            } catch (error) {
                // Error already handled in apiCall
            }
        }

        async function refreshGame() {
            if (!currentGameId) {
                log('‚ö†Ô∏è No hay partida activa', 'warning');
                return;
            }

            try {
                const result = await apiCall(`/test/game/${currentGameId}`);
                currentGameState = result;
                updateGameDisplay();
                
                const handsResult = await apiCall(`/test/hands/${currentGameId}`);
                updatePlayersDisplay(handsResult.hands);
                
                updateStateControls();
                updateCardEditor();
                
            } catch (error) {
                // Error already handled in apiCall
            }
        }

        function updateGameDisplay() {
            const container = document.getElementById('gameInfo');
            const state = currentGameState.gameState;
            
            container.innerHTML = `
                <div class="game-state">
                    <div class="game-info">
                        <div class="info-item">
                            <div class="info-label">Fase</div>
                            <div class="info-value">${getPhaseDisplayName(state.currentPhase)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Mano</div>
                            <div class="info-value">${state.currentHand}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Turno</div>
                            <div class="info-value">${getCurrentPlayerName()}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Estado</div>
                            <div class="info-value">${state.isFinished ? 'üèÜ Fin' : 'üéÆ Activo'}</div>
                        </div>
                    </div>
                    
                    <div class="scores">
                        <div class="score">
                            <div>Equipo 0</div>
                            <div style="font-size: 1.8em; font-weight: 700;">${state.scores[0]}</div>
                        </div>
                        <div class="score">
                            <div>Equipo 1</div>
                            <div style="font-size: 1.8em; font-weight: 700;">${state.scores[1]}</div>
                        </div>
                    </div>
                    
                    ${state.winner !== undefined ? `
                        <div style="text-align: center; margin-top: 16px; font-size: 1.2em; font-weight: 600;">
                            üèÜ Ganador: Equipo ${state.winner}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updatePlayersDisplay(hands) {
            const container = document.getElementById('playersContainer');
            const currentTurn = currentGameState.gameState.currentTurn;
            
            container.innerHTML = `
                <div class="players-grid">
                    ${hands.map((hand, index) => `
                        <div class="player-card team-${hand.team} ${index === currentTurn ? 'active' : ''}"
                             onclick="selectPlayerForEdit('${hand.playerId}')">
                            <div class="player-header">
                                <div class="player-name">
                                    <div class="status-dot ${currentGameState.players[index].isConnected ? 'status-connected' : 'status-disconnected'}"></div>
                                    ${hand.playerName}
                                </div>
                                <div class="team-badge">Equipo ${hand.team}</div>
                            </div>
                            
                            <div class="hand">
                                ${hand.hand.map((card, cardIndex) => `
                                    <div class="card ${selectedCards.get(hand.playerId)?.includes(cardIndex) ? 'selected' : ''}" 
                                         onclick="toggleCardSelection('${hand.playerId}', ${cardIndex}); event.stopPropagation();">
                                        <div class="card-value">${getCardDisplayValue(card.value)}</div>
                                        <div class="card-suit suit-${card.suit}">${getSuitSymbol(card.suit)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="actions">
                                ${getAvailableActions(hand.playerId, index === currentTurn).map(action => `
                                    <button class="btn action-btn ${action.class}" 
                                            onclick="playAction('${hand.playerId}', '${action.type}', ${action.amount || 'null'}); event.stopPropagation();"
                                            ${action.disabled ? 'disabled' : ''}>
                                        ${action.label}
                                    </button>
                                `).join('')}
                                
                                ${selectedCards.get(hand.playerId)?.length > 0 ? `
                                    <button class="btn action-btn btn-warning" 
                                            onclick="discardCards('${hand.playerId}'); event.stopPropagation();">
                                        üóëÔ∏è Descartar (${selectedCards.get(hand.playerId).length})
                                    </button>
                                ` : ''}
                            </div>
                            
                            ${hand.handEvaluation ? `
                                <div style="margin-top: 8px; font-size: 0.8em; color: #718096; text-align: center;">
                                    ${hand.handEvaluation.hand.description}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateStateControls() {
            if (!currentGameState) return;
            
            const container = document.getElementById('stateControls');
            const state = currentGameState.gameState;
            
            container.innerHTML = `
                <div class="control-group">
                    <label class="control-label">Fase Actual:</label>
                    <select class="control-input" id="phaseSelect" onchange="handlePhaseChange(this.value)">
                        <option value="mus" ${state.currentPhase === 'mus' ? 'selected' : ''}>Mus</option>
                        <option value="grande" ${state.currentPhase === 'grande' ? 'selected' : ''}>Grande</option>
                        <option value="chica" ${state.currentPhase === 'chica' ? 'selected' : ''}>Chica</option>
                        <option value="pares" ${state.currentPhase === 'pares' ? 'selected' : ''}>Pares</option>
                        <option value="juego" ${state.currentPhase === 'juego' ? 'selected' : ''}>Juego</option>
                        <option value="punto" ${state.currentPhase === 'punto' ? 'selected' : ''}>Punto</option>
                        <option value="counting" ${state.currentPhase === 'counting' ? 'selected' : ''}>Contando</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Turno Actual:</label>
                    <select class="control-input" id="turnSelect" onchange="handleTurnChange(this.value)">
                        ${currentGameState.players.map((player, index) => `
                            <option value="${index}" ${state.currentTurn === index ? 'selected' : ''}>
                                ${player.name} (Equipo ${player.team})
                            </option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="control-row">
                    <div class="control-group">
                        <label class="control-label">Puntos Equipo 0:</label>
                        <input type="number" class="control-input" id="score0Input" 
                               value="${state.scores[0]}" min="0" max="40" 
                               onchange="handleScoreChange(0, this.value)">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Puntos Equipo 1:</label>
                        <input type="number" class="control-input" id="score1Input" 
                               value="${state.scores[1]}" min="0" max="40" 
                               onchange="handleScoreChange(1, this.value)">
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Mano Actual:</label>
                    <input type="number" class="control-input" id="handInput" 
                           value="${state.currentHand}" min="1" max="20" 
                           onchange="handleHandChange(this.value)">
                </div>
                
                <div class="controls">
                    <button class="btn btn-warning" onclick="resetGame()">üîÑ Reset</button>
                    <button class="btn btn-primary" onclick="nextPhase()">‚è≠Ô∏è Siguiente Fase</button>
                </div>
            `;
        }

        function updateCardEditor() {
            if (!currentGameState || !selectedPlayer) return;
            
            const container = document.getElementById('cardEditor');
            const player = currentGameState.players.find(p => p.id === selectedPlayer);
            
            if (!player) {
                container.innerHTML = `
                    <div class="control-group">
                        <label class="control-label">Seleccionar Jugador:</label>
                        <select class="control-input" onchange="selectPlayerForEdit(this.value)">
                            <option value="">Selecciona un jugador...</option>
                            ${currentGameState.players.map(p => `
                                <option value="${p.id}">${p.name} (Equipo ${p.team})</option>
                            `).join('')}
                        </select>
                    </div>
                `;
                return;
            }
            
            // Initialize card editor data if not exists
            if (!cardEditorData[selectedPlayer]) {
                cardEditorData[selectedPlayer] = [
                    { value: 1, suit: 'oros' },
                    { value: 2, suit: 'copas' },
                    { value: 3, suit: 'espadas' },
                    { value: 4, suit: 'bastos' }
                ];
            }
            
            container.innerHTML = `
                <div class="control-group">
                    <label class="control-label">Seleccionar Jugador:</label>
                    <select class="control-input" onchange="selectPlayerForEdit(this.value)">
                        <option value="">Selecciona un jugador...</option>
                        ${currentGameState.players.map(p => `
                            <option value="${p.id}" ${p.id === selectedPlayer ? 'selected' : ''}>${p.name} (Equipo ${p.team})</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="card-editor">
                    <h4>Editando cartas de ${player.name}</h4>
                    <div class="card-grid">
                        ${[0,1,2,3].map(cardIndex => `
                            <div class="card-edit-item">
                                <label>Carta ${cardIndex + 1}</label>
                                <select class="card-edit-select" 
                                        onchange="updateCardEditorData(${cardIndex}, 'value', this.value)">
                                    <option value="1" ${cardEditorData[selectedPlayer][cardIndex].value === 1 ? 'selected' : ''}>As</option>
                                    <option value="2" ${cardEditorData[selectedPlayer][cardIndex].value === 2 ? 'selected' : ''}>2</option>
                                    <option value="3" ${cardEditorData[selectedPlayer][cardIndex].value === 3 ? 'selected' : ''}>3</option>
                                    <option value="4" ${cardEditorData[selectedPlayer][cardIndex].value === 4 ? 'selected' : ''}>4</option>
                                    <option value="5" ${cardEditorData[selectedPlayer][cardIndex].value === 5 ? 'selected' : ''}>5</option>
                                    <option value="6" ${cardEditorData[selectedPlayer][cardIndex].value === 6 ? 'selected' : ''}>6</option>
                                    <option value="7" ${cardEditorData[selectedPlayer][cardIndex].value === 7 ? 'selected' : ''}>7</option>
                                    <option value="10" ${cardEditorData[selectedPlayer][cardIndex].value === 10 ? 'selected' : ''}>Sota</option>
                                    <option value="11" ${cardEditorData[selectedPlayer][cardIndex].value === 11 ? 'selected' : ''}>Caballo</option>
                                    <option value="12" ${cardEditorData[selectedPlayer][cardIndex].value === 12 ? 'selected' : ''}>Rey</option>
                                </select>
                                <select class="card-edit-select" 
                                        onchange="updateCardEditorData(${cardIndex}, 'suit', this.value)">
                                    <option value="oros" ${cardEditorData[selectedPlayer][cardIndex].suit === 'oros' ? 'selected' : ''}>üü° Oros</option>
                                    <option value="copas" ${cardEditorData[selectedPlayer][cardIndex].suit === 'copas' ? 'selected' : ''}>üî¥ Copas</option>
                                    <option value="espadas" ${cardEditorData[selectedPlayer][cardIndex].suit === 'espadas' ? 'selected' : ''}>‚ö´ Espadas</option>
                                    <option value="bastos" ${cardEditorData[selectedPlayer][cardIndex].suit === 'bastos' ? 'selected' : ''}>üü¢ Bastos</option>
                                </select>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="controls">
                        <button class="btn btn-success" onclick="applyCardChanges()">‚úÖ Aplicar Cambios</button>
                        <button class="btn btn-warning" onclick="randomizePlayerHand()">üé≤ Mano Aleatoria</button>
                        <button class="btn btn-primary" onclick="setPresetHand('paresReyes')">üëë Pares Reyes</button>
                        <button class="btn btn-primary" onclick="setPresetHand('juego31')">üéØ Juego 31</button>
                    </div>
                </div>
            `;
        }

        // Event handlers
        function selectPlayerForEdit(playerId) {
            selectedPlayer = playerId;
            if (playerId) {
                log(`üë§ Jugador seleccionado: ${getPlayerName(playerId)}`, 'info');
            }
            updateCardEditor();
        }

        function updateCardEditorData(cardIndex, property, value) {
            if (!selectedPlayer || !cardEditorData[selectedPlayer]) return;
            
            cardEditorData[selectedPlayer][cardIndex][property] = property === 'value' ? parseInt(value) : value;
            log(`üé¥ Carta ${cardIndex + 1} actualizada: ${property} = ${value}`, 'info');
        }

        async function applyCardChanges() {
            if (!selectedPlayer || !cardEditorData[selectedPlayer]) {
                log('‚ö†Ô∏è No hay jugador seleccionado o datos de cartas', 'warning');
                return;
            }

            try {
                log('üé¥ Aplicando cambios de cartas...', 'info');
                
                // Here you would implement the API call to update player cards
                // For now, just log the changes
                const cards = cardEditorData[selectedPlayer];
                log(`‚úÖ Cartas actualizadas para ${getPlayerName(selectedPlayer)}: ${cards.map(c => `${getCardDisplayValue(c.value)} de ${c.suit}`).join(', ')}`, 'success');
                
                await refreshGame();
            } catch (error) {
                // Error already handled
            }
        }

        function handlePhaseChange(newPhase) {
            log(`üîÑ Cambiando fase a: ${getPhaseDisplayName(newPhase)}`, 'info');
            // Implement phase change API call
        }

        function handleTurnChange(newTurn) {
            const playerName = currentGameState.players[newTurn].name;
            log(`üéØ Cambiando turno a: ${playerName}`, 'info');
            // Implement turn change API call
        }

        function handleScoreChange(team, newScore) {
            log(`üìä Cambiando puntuaci√≥n equipo ${team} a: ${newScore}`, 'info');
            // Implement score change API call
        }

        function handleHandChange(newHand) {
            log(`üìã Cambiando a mano: ${newHand}`, 'info');
            // Implement hand change API call
        }

        // Game actions
        function getAvailableActions(playerId, isCurrentTurn) {
            if (!currentGameState || !isCurrentTurn) {
                return [];
            }

            const phase = currentGameState.gameState.currentPhase;
            const actions = [];

            switch (phase) {
                case 'mus':
                    actions.push(
                        { type: 'mus', label: '‚úã Mus', class: 'btn-primary' },
                        { type: 'no-mus', label: 'üö´ No Mus', class: 'btn-danger' }
                    );
                    break;

                case 'grande':
                case 'chica':
                case 'juego':
                case 'punto':
                    actions.push(
                        { type: 'paso', label: 'üëã Paso', class: 'btn-warning' },
                        { type: 'envido', label: 'üí∞ Envido 2', class: 'btn-success', amount: 2 },
                        { type: 'envido', label: 'üí∞ Envido 3', class: 'btn-success', amount: 3 },
                        { type: 'ordago', label: 'üî• √ìrdago', class: 'btn-danger' }
                    );
                    break;

                case 'pares':
                    actions.push(
                        { type: 'paso', label: 'üëã Paso', class: 'btn-warning' },
                        { type: 'ordago', label: 'üî• √ìrdago', class: 'btn-danger' }
                    );
                    break;
            }

            if (currentGameState.gameState.phaseData.currentBet) {
                return [
                    { type: 'acepto', label: '‚úÖ Acepto', class: 'btn-success' },
                    { type: 'rechazo', label: '‚ùå Rechazo', class: 'btn-danger' }
                ];
            }

            return actions;
        }

        function toggleCardSelection(playerId, cardIndex) {
            if (!selectedCards.has(playerId)) {
                selectedCards.set(playerId, []);
            }
            
            const selected = selectedCards.get(playerId);
            const index = selected.indexOf(cardIndex);
            
            if (index > -1) {
                selected.splice(index, 1);
            } else {
                selected.push(cardIndex);
            }
            
            refreshGame();
        }

        async function playAction(playerId, actionType, amount = null) {
            try {
                const action = { type: actionType };
                if (amount !== null) {
                    action.amount = amount;
                }

                log(`üéØ ${getCurrentPlayerName()} juega: ${actionType}${amount ? ` (${amount})` : ''}`, 'info');
                
                const result = await apiCall(`/test/action/${currentGameId}`, {
                    method: 'POST',
                    body: JSON.stringify({ playerId, action })
                });

                log(`‚úÖ ${result.result.message}`, 'success');
                
                if (result.result.phaseComplete) {
                    log(`üèÅ Fase completada: ${result.result.message}`, 'success');
                }

                await refreshGame();
            } catch (error) {
                // Error already handled
            }
        }

        async function discardCards(playerId) {
            const cardIndices = selectedCards.get(playerId) || [];
            
            if (cardIndices.length === 0) {
                log('‚ö†Ô∏è Selecciona cartas para descartar', 'warning');
                return;
            }

            try {
                log(`üóëÔ∏è Descartando ${cardIndices.length} cartas...`, 'info');
                
                const result = await apiCall(`/test/discard/${currentGameId}`, {
                    method: 'POST',
                    body: JSON.stringify({ playerId, cardIndices })
                });

                log(`‚úÖ ${result.message}`, 'success');
                selectedCards.delete(playerId);
                
                await refreshGame();
            } catch (error) {
                // Error already handled
            }
        }

        async function setPresetHand(handType) {
            if (!selectedPlayer) {
                log('‚ö†Ô∏è Selecciona un jugador primero', 'warning');
                return;
            }

            try {
                log(`üé¥ Estableciendo mano ${handType}...`, 'info');
                
                const result = await apiCall(`/test/set-hand/${currentGameId}`, {
                    method: 'POST',
                    body: JSON.stringify({ playerId: selectedPlayer, handType })
                });

                log(`‚úÖ ${result.message}`, 'success');
                await refreshGame();
            } catch (error) {
                // Error already handled
            }
        }

        async function simulateGame() {
            if (!currentGameId) {
                log('‚ö†Ô∏è No hay partida activa', 'warning');
                return;
            }

            try {
                log('ü§ñ Iniciando simulaci√≥n autom√°tica...', 'info');
                
                await apiCall(`/test/simulate/${currentGameId}`, { method: 'POST' });
                
                log('‚úÖ Simulaci√≥n iniciada en background', 'success');
                
                const interval = setInterval(async () => {
                    await refreshGame();
                    
                    if (currentGameState?.gameState.isFinished) {
                        clearInterval(interval);
                        log('üèÜ Simulaci√≥n completada', 'success');
                    }
                }, 2000);
                
            } catch (error) {
                // Error already handled
            }
        }

        async function runBasicTests() {
            try {
                log('üß™ Ejecutando tests b√°sicos...', 'info');
                
                const result = await apiCall('/test/run-basic');
                
                result.logs.forEach(logEntry => {
                    const type = logEntry.includes('ERROR') ? 'error' : 
                               logEntry.includes('‚úÖ') ? 'success' : 'info';
                    log(logEntry.replace(/^(INFO|ERROR): /, ''), type);
                });
                
            } catch (error) {
                // Error already handled
            }
        }

        async function cleanup() {
            try {
                log('üßπ Limpiando partidas...', 'info');
                
                await apiCall('/test/cleanup', { method: 'DELETE' });
                
                currentGameId = null;
                currentGameState = null;
                selectedCards.clear();
                selectedPlayer = null;
                cardEditorData = {};
                
                document.getElementById('simulateBtn').disabled = true;
                document.getElementById('refreshBtn').disabled = true;
                document.getElementById('stateControlsSection').style.display = 'none';
                document.getElementById('cardEditorSection').style.display = 'none';
                
                document.getElementById('gameInfo').innerHTML = '<div class="loading show"><p>No hay partida activa.<br>Crea una partida para empezar.</p></div>';
                document.getElementById('playersContainer').innerHTML = '<div class="loading show"><p>Esperando partida...</p></div>';
                
                log('‚úÖ Limpieza completada', 'success');
                
            } catch (error) {
                // Error already handled
            }
        }

        // Utility functions
        function getPhaseDisplayName(phase) {
            const names = {
                'waiting': 'Esperando',
                'mus': 'Mus',
                'grande': 'Grande',
                'chica': 'Chica',
                'pares': 'Pares',
                'juego': 'Juego',
                'punto': 'Punto',
                'counting': 'Contando',
                'finished': 'Terminada'
            };
            return names[phase] || phase;
        }

        function getCurrentPlayerName() {
            if (!currentGameState) return 'N/A';
            const currentTurn = currentGameState.gameState.currentTurn;
            return currentGameState.players[currentTurn]?.name || 'N/A';
        }

        function getPlayerName(playerId) {
            if (!currentGameState) return 'N/A';
            const player = currentGameState.players.find(p => p.id === playerId);
            return player?.name || 'N/A';
        }

        function getCardDisplayValue(value) {
            const names = {
                1: 'A',
                2: '2',
                3: '3',
                4: '4',
                5: '5',
                6: '6',
                7: '7',
                10: 'S',
                11: 'C',
                12: 'R'
            };
            return names[value] || value;
        }

        function getSuitSymbol(suit) {
            const symbols = {
                'oros': 'üü°',
                'copas': 'üî¥',
                'espadas': '‚ö´',
                'bastos': 'üü¢'
            };
            return symbols[suit] || suit;
        }

        // Auto-refresh
        setInterval(() => {
            if (currentGameId && currentGameState && !currentGameState.gameState.isFinished) {
                refreshGame();
            }
        }, 5000);

        // Initialize
        log('üéÆ Simulador de Mus cargado y listo', 'success');
        log('üí° Crea una partida para acceder a todas las funciones', 'info');
    </script>
</body>
</html>
